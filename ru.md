# Методология Step-Based Estimation (SBE)

## Описание методологии

**Step-Based Estimation** — подход к планированию разработки, при котором каждая задача декомпозируется на детальные, конкретные шаги выполнения с последующим анализом зависимостей и возможностью ретроспективного сравнения плана с фактом.

В дополнение к Acceptance Criteria, которые как правило являются декларативным представлением задачи, Implementation Steps — это императивное описание того, как именно задача будет реализована.

### Процесс SBE:

**Организация работы:**

- **Refinement сессия**: Обычная эстимация задач через agile poker
- **Step Estimation сессия**: Отдельная встреча для детальной декомпозиции

**Выбор задач для детализации**: На Step Estimation выносятся задачи по результатам голосования команды

**Этапы работы над задачей:**

1. **Декомпозиция**: Разбить задачу на конкретные шаги ("Добавить поле X в форму Y", "Обновить функцию Z в модуле W", "Создать репозиторий для источника данных Y").
2. **Поиск скрытых подзадач**: Выявить шаги, которые могут быть вынесены в отдельные задачи.
3. **Эстимация**: Оценить задачу по общему количеству шагов (используя Фибоначчи).
4. **Ретроспектива** _(опционально)_: Сравнить запланированные шаги с фактически выполненными, выявить паттерны расхождений, принять к сведению при будущих эстимациях.

---

## Сравнение подходов к эстимации

| Аспект               | Refinement (оптимистичная)                                                                                  | Step Estimation (пессимистичная)                                                                                                                                                                                                                                                                                                                               |
| -------------------- | ----------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Характер**         | Высокоуровневая, быстрая, основана на общем понимании                                                       | Детальная, основана на конкретных шагах реализации                                                                                                                                                                                                                                                                                                             |
| **Когда возникает**  | • На начальном этапе планирования<br>• При первом знакомстве с задачей<br>• Основана на Acceptance Criteria | • После Refinement, перед началом спринта<br>• Для сложных/рискованных задач<br>• Основана на Implementation Steps                                                                                                                                                                                                                                             |
| **Преимущества**     | ✓ Быстрая                                                                                                   | ✓ Учитывает детали<br>✓ Выявляет скрытые шаги<br>✓ Более реалистична                                                                                                                                                                                                                                                                                           |
| **Недостатки**       | ⚠ Склонна к недооценке сложности<br>⚠ Не учитывает детали реализации<br>⚠ Пропускает "скрытые" шаги         | ⚠ Требует больше времени<br>⚠ Требует технической экспертизы                                                                                                                                                                                                                                                                                                   |
| **Типичные вопросы** | • "Это примерно как та задача?"<br>• "Звучит как 5 поинтов"<br>• "Acceptance Criteria выглядят простыми"    | • "Какие классы, модули и функции нужно будет изменить?"<br>• "Какие репозитории и источники данных затронуты?"<br>• "Какие состояния небходимо учесть?"<br>• "Если программную сущность представить черным ящиком, какким интерфейсом опишутся аргументы и возвращаемое значение?"<br>• "Если есть зависимые задачи, как они интегрируются после выполнения?" |

---

## Синергия двух подходов

### Классическая проблема (только Refinement)

```
Команда на Refinement: "Добавить фильтры в таблицу — 3 поинта!"

Реальность в спринте:
- День 1: "Ой, нужно переделать структуру базы данных"
- День 2: "Ой, нужно добавить индексы для производительности"
- День 3: "Ой, нужно обработать edge cases с пустыми данными"
- День 4: "Ой, нужно адаптировать UI под мобильные устройства"
- День 5: "Ой, нужно написать 15 тестов вместо 5"

Результат: 3 SP превратились в 8 SP, задача не влезла в спринт
```

### С применением SBE (Refinement + Step Estimation)

```
Refinement (оптимистичная): 3 SP
↓
Голосование команды: вынести на Step Estimation
↓
Step Estimation (пессимистичная): детализация выявляет:
- 12 шагов вместо предполагаемых 5
- Нужна миграция БД
- Потребуется 15 тестов
- Затрагивается 6 классов
↓
Корректировка: 3 SP → 5 SP
↓
Результат: более реалистичная оценка, задача влезает в спринт
```

### Психология эстимации

**Refinement (оптимизм):**

- Команда фокусируется на "happy path"
- "Мы уже делали похожее, будет быстро"
- Недооценка сложности — естественная когнитивная ошибка

**Step Estimation (реализм):**

- Детализация заставляет думать о проблемах
- "А что если...", "Нужно учесть..."
- Выявление скрытых сложностей

**Баланс:**
Оптимистичная оценка на Refinement → быстрое планирование бэклога
Пессимистичная оценка на Step Estimation → реалистичное планирование спринта

---

## Преимущества подхода

### 1. **Повышение точности эстимаций**

- Детализация выявляет скрытые подзадачи на этапе планирования
- Накапливается база знаний о реальной трудозатратности типовых шагов
- Снижается влияние оптимизма и когнитивных искажений

### 2. **Улучшение планирования спринта**

- Возможность распараллеливания независимых шагов
- Выявление критического пути проекта
- Более равномерная загрузка команды

### 3. **Структурированная ретроспектива** _(опционально)_

- Конкретные данные вместо субъективных ощущений
- Выявление системных проблем в процессах
- Материал для улучшения будущих эстимаций

### 4. **Снижение рисков**

- Раннее выявление зависимостей между задачами
- Предотвращение "забытых" шагов
- Возможность раннего перепланирования при отклонениях

### 5. **Прозрачность прогресса**

- Более детальное отслеживание готовности задач
- Раннее выявление блокеров и проблем

### 6. **Предварительная оценка тестового покрытия**

- Поверхностная оценка объема необходимых юнит-тестов
- Планирование усилий на тестирование на этапе эстимации

---

## Организация процесса

### Refinement сессия (основная)

**Цель:** Первичная оценка задач бэклога

**Участники:** Вся команда разработки

**Процесс:**

1. Product Owner представляет задачу
2. Обсуждение Acceptance Criteria
3. Уточняющие вопросы
4. Эстимация через agile poker (Planning Poker)
5. Фиксация оценки в story points

**Длительность:** 1-2 часа

**Характер оценки:** Оптимистичная, быстрая, высокоуровневая

### Step Estimation сессия (дополнительная)

**Цель:** Детальная декомпозиция сложных задач

**Участники:**

- Обязательно: разработчики, которые будут работать над задачей
- Желательно: Tech Lead, QA Engineer
- Опционально: Product Owner (для уточнения требований)

**Выбор задач для детализации:**
Команда голосует за задачи, которые нуждаются в детализации:

- Задачи с интуитивной неопределенностью
- Задачи 5+ story points
- Задачи, затрагивающие критичные компоненты
- Задачи с техническими рисками (breaking changes, внешние интеграции)
- Задачи, где оценка на Refinement вызвала споры

**Процесс:**

1. Выбор задачи для детализации (по результатам голосования)
2. Декомпозиция на Implementation Steps
3. Оценка количества необходимых тестов
4. Выявление зависимостей между шагами
5. Возможность корректировки первоначальной оценки
6. Переход к следующей задаче

**Длительность:** 1-1.5 часа (детализируется 3-5 задач)

**Частота:** 1 раз в спринт или по необходимости

**Характер оценки:** Пессимистичная, детальная, реалистичная

---

## Практические примеры

### Пример 1: Эффект оптимизма vs реализма

**Задача:** "Добавить двухфакторную аутентификацию"

**Refinement (оптимистичная оценка):**

```
Обсуждение (5 минут):
Dev 1: "Нужно добавить поле в базу, сделать форму, подключить библиотеку TOTP"
Dev 2: "Да, звучит как средняя задача"
Dev 3: "Мы уже делали похожее с email подтверждением"
PO: "Acceptance Criteria простые: включить, отключить, использовать при входе"

Голосование: 5, 5, 5, 8
Консенсус: 5 SP

Мышление: "Основной функционал понятен, библиотека все сделает"
```

**Step Estimation (пессимистичная оценка):**

```
Детализация (20 минут):

Implementation Steps:
1. Создать миграцию для поля two_factor_secret в таблице users
2. Добавить поле two_factor_enabled (boolean)
3. Добавить методы enable2FA/disable2FA в User модель
4. Установить библиотеку для генерации TOTP кодов
5. Изучить документацию библиотеки для edge cases
6. Создать контроллер TwoFactorController
7. Реализовать генерацию QR-кода для настройки
8. Добавить проверку TOTP при логине в AuthController
9. Обработать случай, когда пользователь потерял устройство
10. Создать систему резервных кодов восстановления
11. Создать UI для включения/отключения 2FA
12. Создать UI для показа QR-кода
13. Создать UI для показа резервных кодов
14. Добавить rate limiting для попыток ввода кода
15. Написать unit-тесты для User модели (4 теста)
16. Написать тесты для TwoFactorController (5 тестов)
17. Написать тесты для BackupCodeService (3 теста)
18. Написать интеграционные тесты (3 теста)
19. Обновить документацию API
20. Протестировать на разных устройствах
21. Протестировать интеграцию с мобильными приложениями

Тесты: ~15 unit + 3 интеграционных = 18 тестов

Обсуждение:
Dev 1: "О, я забыл про резервные коды при первой оценке"
Dev 2: "И про rate limiting тоже не подумал"
Dev 3: "Тестирование займет больше времени, чем я думал"
Tech Lead: "Плюс нужно учесть безопасность и edge cases"

Переоценка: 5 SP → 8 SP

Мышление: "Когда начинаешь детализировать, понимаешь реальный объем работы"
```

### Пример 2: Корректировка после детализации

**Задача:** "Добавить экспорт отчетов в PDF и Excel"

**Refinement (оптимистичная):**

```
Команда: "Библиотеки для PDF и Excel есть готовые,
просто подключим и сделаем кнопку экспорта"

Оценка: 3 SP
```

**Step Estimation (пессимистичная):**

```
Детализация выявила:

1. Выбор библиотек (исследование):
   - Сравнить 3 PDF библиотеки
   - Сравнить 2 Excel библиотеки
   - Проверить лицензии

2. PDF экспорт (8 шагов):
   - Настроить библиотеку
   - Настроить шрифты (кроме латиницы)
   - Обработать таблицы
   - Обработать графики
   - Настроить пагинацию
   - Добавить стили компании (логотип, цвета)
   - Оптимизировать размер файла
   - Тесты (4 теста)

3. Excel экспорт (6 шагов):
   - Настроить библиотеку
   - Экспорт данных таблицы
   - Форматирование ячеек
   - Формулы для итоговых строк
   - Защита листов
   - Тесты (3 теста)

4. UI и интеграция (5 шагов):
   - Добавить кнопки экспорта
   - Добавить выбор формата
   - Прогресс-бар для больших отчетов
   - Обработка ошибок
   - Тесты UI (2 теста)

5. Производительность (3 шага):
   - Фоновая генерация для больших файлов
   - Ограничения на размер данных
   - Очистка временных файлов

6. Документация и edge cases (3 шага):
   - Обновить пользовательскую документацию
   - Тестирование с граничными объемами данных
   - Тестирование с различными браузерами

Итого: 25+ шагов, 9+ тестов

Обсуждение:
Dev: "О, я совсем забыл про другие языки в PDF..."
QA: "А как обрабатываем ситуацию с миллионом строк?"
Tech Lead: "Нужна будет фоновая обработка, это отдельная задача"

Решение: Разбить на 2 задачи:
- "PDF экспорт" - 5 SP
- "Excel экспорт" - 3 SP
Вместо изначальных 3 SP для всего
```

---

## Уровни применения методологии

SBE можно применять с разной степенью детализации в зависимости от потребностей команды:

### Базовый уровень (минимальное внедрение)

**Что делаем:**

- Проводим Refinement + Step Estimation сессии
- Декомпозируем задачи на конкретные шаги
- Анализируем зависимости для параллелизации
- Оцениваем необходимые тесты

**Что получаем:**

- Более точные эстимации
- Лучшее планирование спринта
- Предсказуемость объема тестирования
- Баланс между оптимизмом Refinement и реализмом Step Estimation

**Трудозатраты:** +10-15% времени на планирование (дополнительная 1.5 часа Step Estimation)

### Продвинутый уровень (с ретроспективой)

**Дополнительно делаем:**

- Фиксируем фактически выполненные шаги
- Сравниваем план с фактом
- Анализируем паттерны расхождений
- Создаем шаблоны для типовых задач

**Дополнительно получаем:**

- Постоянное улучшение точности эстимаций
- База знаний команды о типовых задачах
- Выявление системных проблем в процессе

**Дополнительные трудозатраты:** +5-10% времени на ретроспективу

---

## Внедрение методологии

### Начальный этап (1-2 спринта) - Базовый уровень

**Организационные изменения:**

- Добавить Step Estimation сессию в календарь команды (1-1.5 часа/спринт)
- Определить критерии для голосования за задачи
- Создать шаблон для фиксации Implementation Steps

**Процесс:**

- Выбрать 2-3 задачи на Step Estimation по голосованию
- Фокус на декомпозиции и анализе зависимостей
- Оценка необходимого тестового покрытия
- Сравнение оптимистичных и пессимистичных оценок

### Развитие (3-6 спринтов) - Можно добавить ретроспективу

- Расширить количество детализируемых задач (до 5-7)
- Создание шаблонов для повторяющихся типов задач
- _(Опционально)_ Начать сбор данных: planned vs actual
- _(Опционально)_ Анализ паттернов расхождений

---

## Return on Investment методологии

### Базовый уровень

**Инвестиции:** +10-15% времени на планирование (дополнительная 1.5 часа Step Estimation)

**Возврат:**

- Снижение overrun'ов
- Улучшение планирования тестирования
- Повышение предсказуемости сроков

### Продвинутый уровень

**Инвестиции:** +15-25% времени на планирование и ретроспективу

**Возврат:**

- Дополнительное снижение overrun'ов
- Постоянное улучшение процессов
- Накопление базы знаний команды
- Сокращение времени на аналогичные задачи в будущем
